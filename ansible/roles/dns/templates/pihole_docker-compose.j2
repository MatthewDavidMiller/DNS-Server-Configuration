version: "3.2"

# Credits
# https://stackoverflow.com/questions/57342238/how-to-start-with-docker-dockerfile-and-docker-compose
# https://stackoverflow.com/questions/44884719/exited-with-code-0-docker
# https://www.xfelix.com/2020/09/pihole-unbound-docker-setup-on-raspberry-pi/
# https://github.com/compose-spec/compose-spec/blob/master/spec.md

networks:
  pihole_net:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.16.1.0/29

services:
  pihole:
    container_name: pihole
    image: pihole/pihole:latest

    networks:
      pihole_net:
        ipv4_address: 172.16.1.2

    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "443:443/tcp"
      - "80:80/tcp"
    environment:
      TZ: 'America/Chicago'
      WEBPASSWORD: {{ web_password }}

    volumes:
      - type: volume
        source: ./etc-pihole
        target: /etc/pihole

      - type: volume
        source: ./etc-dnsmasq.d
        target: /etc/dnsmasq.d

      - type: bind
        source: ./etc-lighttpd/external.conf
        target: /etc/lighttpd/external.conf

      - type: bind
        source: ./etc-lighttpd/cert_privkey_combined.pem
        target: /etc/lighttpd/cert_privkey_combined.pem

    cap_add:
      - NET_ADMIN

    dns:
      - 172.16.1.3:5353

    restart: unless-stopped

  unbound:
    container_name: unbound
    image: alpine/alpine:latest

    networks:
      pihole_net:
        ipv4_address: 172.16.1.3

    ports:
      - "5353:5353/tcp"
      - "5353:5353/udp"

    environment:
      TZ: 'America/Chicago'

    volumes:
      - type: bind
        source: ./etc-unbound/unbound.conf.d/pi-hole.conf
        target: /etc/unbound/unbound.conf.d/pi-hole.conf

      - type: bind
        source: ./var-lib-unbound/root.hints
        target: /var/lib/unbound/root.hints

    tty: true

    build: ./unbound_dockerfile

    restart: unless-stopped

volumes:
  etc-pihole:
  etc-dnsmasq.d:
